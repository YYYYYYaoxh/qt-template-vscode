name: windows-qt6-mingw

"on":
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:
    inputs:
      build_mode:
        description: "Build mode: conan (with Conan deps) or qt (pure Qt)"
        required: false
        default: "conan"
      qt_version:
        description: "Qt version"
        required: false
        default: "6.5.3"
      qt_arch:
        description: "Qt arch (install-qt-action arch)"
        required: false
        default: "win64_mingw"
      qt_tools:
        description: "Qt tools (install-qt-action tools)"
        required: false
        default: "tools_mingw90"
      app_name:
        description: "CMake APP_NAME (-DAPP_NAME=...)"
        required: false
        default: ""
      exe_name:
        description: "Executable file name"
        required: false
        default: ""
      exe_relative_path:
        description: "Path to built exe (relative to repo root)"
        required: false
        default: ""
      zip_name:
        description: "Zip file name"
        required: false
        default: ""
      release_tag:
        description: "Release tag (e.g. v1.0.0)"
        required: false
        default: ""
      prerelease:
        description: "Mark as prerelease (true/false)"
        required: false
        default: "false"
      draft:
        description: "Create as draft (true/false)"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  build-package:
    runs-on: windows-2022

    strategy:
      fail-fast: false
      matrix:
        build_mode: [conan,qt]

    env:
      BUILD_MODE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_mode || matrix.build_mode }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve build variables (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $inputQtVersion = "${{ github.event.inputs.qt_version }}"
          $repoQtVersion = "${{ vars.QT_VERSION }}"
          $qtVersion = if (-not [string]::IsNullOrWhiteSpace($inputQtVersion)) { $inputQtVersion } elseif (-not [string]::IsNullOrWhiteSpace($repoQtVersion)) { $repoQtVersion } else { "6.5.3" }

          $inputQtArch = "${{ github.event.inputs.qt_arch }}"
          $repoQtArch = "${{ vars.QT_ARCH }}"
          $qtArch = if (-not [string]::IsNullOrWhiteSpace($inputQtArch)) { $inputQtArch } elseif (-not [string]::IsNullOrWhiteSpace($repoQtArch)) { $repoQtArch } else { "win64_mingw" }

          $inputQtTools = "${{ github.event.inputs.qt_tools }}"
          $repoQtTools = "${{ vars.QT_TOOLS }}"
          $qtTools = if (-not [string]::IsNullOrWhiteSpace($inputQtTools)) { $inputQtTools } elseif (-not [string]::IsNullOrWhiteSpace($repoQtTools)) { $repoQtTools } else { "tools_mingw90" }

          $inputAppName = "${{ github.event.inputs.app_name }}"
          $repoAppName = "${{ vars.APP_NAME }}"
          $repoName = "${{ github.event.repository.name }}"
          $appName = if (-not [string]::IsNullOrWhiteSpace($inputAppName)) { $inputAppName } elseif (-not [string]::IsNullOrWhiteSpace($repoAppName)) { $repoAppName } elseif (-not [string]::IsNullOrWhiteSpace($repoName)) { $repoName } else { "qt6_minimal" }

          $inputExeName = "${{ github.event.inputs.exe_name }}"
          $exeName = if ([string]::IsNullOrWhiteSpace($inputExeName)) { "$appName.exe" } else { $inputExeName }

          $inputExeRelativePath = "${{ github.event.inputs.exe_relative_path }}"
          if ($env:BUILD_MODE -eq 'qt') {
            $defaultExeRelativePath = "build-qt6-release/bin/$exeName"
          } else {
            $defaultExeRelativePath = "build-conan-release/bin/$exeName"
          }
          $exeRelativePath = if ([string]::IsNullOrWhiteSpace($inputExeRelativePath)) { $defaultExeRelativePath } else { $inputExeRelativePath }

          $inputZipName = "${{ github.event.inputs.zip_name }}"
          $zipName = if ([string]::IsNullOrWhiteSpace($inputZipName)) { "$appName-windows.zip" } else { $inputZipName }

          $inputReleaseTag = "${{ github.event.inputs.release_tag }}"
          $releaseTag = if (-not [string]::IsNullOrWhiteSpace($inputReleaseTag)) { $inputReleaseTag } else { "" }

          $draftFlag = "${{ github.event.inputs.draft }}"
          $prereleaseFlag = "${{ github.event.inputs.prerelease }}"

          "QT_VERSION=$qtVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "QT_ARCH=$qtArch" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "QT_TOOLS=$qtTools" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "APP_NAME=$appName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "EXE_NAME=$exeName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "EXE_RELATIVE_PATH=$exeRelativePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RELEASE_TAG=$releaseTag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DRAFT_FLAG=$draftFlag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "PRERELEASE_FLAG=$prereleaseFlag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Resolve build variables (push/pull_request)
        if: github.event_name != 'workflow_dispatch'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $repoQtVersion = "${{ vars.QT_VERSION }}"
          $qtVersion = if (-not [string]::IsNullOrWhiteSpace($repoQtVersion)) { $repoQtVersion } else { "6.5.3" }

          $repoQtArch = "${{ vars.QT_ARCH }}"
          $qtArch = if (-not [string]::IsNullOrWhiteSpace($repoQtArch)) { $repoQtArch } else { "win64_mingw" }

          $repoQtTools = "${{ vars.QT_TOOLS }}"
          $qtTools = if (-not [string]::IsNullOrWhiteSpace($repoQtTools)) { $repoQtTools } else { "tools_mingw90" }

          $repoAppName = "${{ vars.APP_NAME }}"
          $repoName = "${{ github.event.repository.name }}"
          $appName = if (-not [string]::IsNullOrWhiteSpace($repoAppName)) { $repoAppName } elseif (-not [string]::IsNullOrWhiteSpace($repoName)) { $repoName } else { "qt6_minimal" }

          $exeName = "$appName.exe"
          if ($env:BUILD_MODE -eq 'qt') {
            $exeRelativePath = "build-qt6-release/bin/$exeName"
          } else {
            $exeRelativePath = "build-conan-release/bin/$exeName"
          }
          $zipName = "$appName-windows.zip"

          "QT_VERSION=$qtVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "QT_ARCH=$qtArch" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "QT_TOOLS=$qtTools" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "APP_NAME=$appName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "EXE_NAME=$exeName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "EXE_RELATIVE_PATH=$exeRelativePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RELEASE_TAG=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DRAFT_FLAG=false" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "PRERELEASE_FLAG=false" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        shell: pwsh
        run: |
          pip install Pillow
          if ($env:BUILD_MODE -eq 'conan') {
            pip install conan
          }

      - name: Setup Conan
        if: env.BUILD_MODE == 'conan'
        shell: pwsh
        run: |
          conan profile detect --force

      - name: Install Conan dependencies
        if: env.BUILD_MODE == 'conan'
        shell: pwsh
        run: |
          # Use pre-installed MinGW on Windows runner (Qt MinGW not available yet at this step)
          $gcc = "C:/mingw64/bin/gcc.exe"
          $gxx = "C:/mingw64/bin/g++.exe"
          
          if (-not (Test-Path $gxx)) {
            throw "MinGW g++ not found at $gxx. Please ensure MinGW is installed."
          }
          
          Write-Host "Using MinGW gcc: $gcc"
          Write-Host "Using MinGW g++: $gxx"
          
          # Configure Conan to use MinGW instead of MSVC with Ninja generator
          # Use double quotes for proper variable expansion
          conan install . --output-folder=build-conan-release --build=missing -s build_type=Release `
            -s compiler=gcc -s compiler.version=13 -s compiler.libcxx=libstdc++11 `
            -c tools.cmake.cmaketoolchain:generator=Ninja `
            -c "tools.build:compiler_executables={'c': '$gcc', 'cpp': '$gxx'}"

      - name: Install Inkscape for SVG conversion (if needed)
        shell: pwsh
        run: |
          # Check if SVG file exists, only install Inkscape if needed
          if (Test-Path "resources/icons/app_icon.svg") {
            Write-Host "SVG file found, installing Inkscape"
            choco install inkscape -y
          } else {
            Write-Host "No SVG file found, skipping Inkscape installation"
          }

      - name: Convert SVG to ICO for Windows icon
        shell: pwsh
        run: |
          $icoPath = "resources/icons/app_icon.ico"
          $svgPath = "resources/icons/app_icon.svg"
          $pngPath = "resources/icons/app_icon.png"
          $jpgPath = "resources/icons/app_icon.jpg"
          $jpegPath = "resources/icons/app_icon.jpeg"

          # Find the most recent source file
          $sourceFile = $null
          $sourceTime = 0

          if (Test-Path $svgPath) {
            $sourceFile = $svgPath
            $sourceTime = (Get-Item $svgPath).LastWriteTime.Ticks
          }
          if (Test-Path $pngPath) {
            $pngTime = (Get-Item $pngPath).LastWriteTime.Ticks
            if ($pngTime -gt $sourceTime) {
              $sourceFile = $pngPath
              $sourceTime = $pngTime
            }
          }
          if (Test-Path $jpgPath) {
            $jpgTime = (Get-Item $jpgPath).LastWriteTime.Ticks
            if ($jpgTime -gt $sourceTime) {
              $sourceFile = $jpgPath
              $sourceTime = $jpgTime
            }
          }
          if (Test-Path $jpegPath) {
            $jpegTime = (Get-Item $jpegPath).LastWriteTime.Ticks
            if ($jpegTime -gt $sourceTime) {
              $sourceFile = $jpegPath
              $sourceTime = $jpegTime
            }
          }

          if (-not $sourceFile) {
            Write-Host "No supported icon file found (SVG, PNG, JPG, JPEG)"
            exit 1
          }

          if (Test-Path $icoPath) {
            $icoTime = (Get-Item $icoPath).LastWriteTime.Ticks
            if ($icoTime -ge $sourceTime) {
              Write-Host "ICO file is up-to-date, skipping conversion"
              Write-Host "Source: $sourceFile ($(Get-Item $sourceFile).LastWriteTime))"
              Write-Host "ICO: $icoPath ($(Get-Item $icoPath).LastWriteTime))"
            } else {
              Write-Host "Source file is newer, converting: $sourceFile"
              python scripts/convert_icon.py
            }
          } else {
            Write-Host "ICO file not found, converting from: $sourceFile"
            python scripts/convert_icon.py
          }

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Install Qt 6.5.3 with MinGW toolchain
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: ${{ env.QT_ARCH }}
          tools: ${{ env.QT_TOOLS }}
          cache: true
          setup-python: false
          add-tools-to-path: true

      - name: Diagnostics (environment)
        shell: pwsh
        run: |
          Write-Host "=== Environment ==="
          Write-Host "QT_ROOT_DIR=$env:QT_ROOT_DIR"
          Write-Host "IQTA_TOOLS=$env:IQTA_TOOLS"
          Write-Host ""
          Write-Host "=== Compilers in PATH ==="
          where.exe gcc 2>$null || Write-Host "gcc not found in PATH"
          where.exe g++ 2>$null || Write-Host "g++ not found in PATH"
          Write-Host ""
          Write-Host "=== Qt Tools MinGW ==="
          $mingwDir = Get-ChildItem -Path "$env:IQTA_TOOLS" -Filter "mingw*" -Directory -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($mingwDir) {
            Write-Host "Found MinGW at: $($mingwDir.FullName)"
            $gxx = Join-Path $mingwDir.FullName "bin\g++.exe"
            if (Test-Path $gxx) {
              Write-Host "g++ version:"
              & $gxx --version
            }
          } else {
            Write-Host "No MinGW found in IQTA_TOOLS, checking C:\mingw64..."
            if (Test-Path "C:\mingw64\bin\g++.exe") {
              Write-Host "Using pre-installed MinGW at C:\mingw64"
              & "C:\mingw64\bin\g++.exe" --version
            }
          }

      - name: Configure (CMake)
        shell: pwsh
        run: |
          $mingwBin = $null
          if ($env:IQTA_TOOLS) {
            $mingwDir = Get-ChildItem -Path "$env:IQTA_TOOLS" -Filter "mingw*" -Directory -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($mingwDir) {
              $mingwBin = Join-Path $mingwDir.FullName "bin"
            }
          }
          if (-not $mingwBin -or -not (Test-Path "$mingwBin\g++.exe")) {
            $mingwBin = "C:\mingw64\bin"
          }
          Write-Host "Using MinGW from: $mingwBin"
          $gcc = Join-Path $mingwBin "gcc.exe"
          $gxx = Join-Path $mingwBin "g++.exe"
          if (-not (Test-Path $gxx)) { throw "g++ not found at $gxx" }
          if ($env:BUILD_MODE -eq 'qt') {
            cmake -S . -B build-qt6-release -G Ninja -DCMAKE_BUILD_TYPE=Release `
              -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR" `
              -DCMAKE_C_COMPILER="$gcc" `
              -DCMAKE_CXX_COMPILER="$gxx" `
              -DAPP_NAME="$env:APP_NAME"
          } else {
            cmake -S . -B build-conan-release -G Ninja -DCMAKE_BUILD_TYPE=Release `
              -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR" `
              -DCMAKE_TOOLCHAIN_FILE="build-conan-release/build/generators/conan_toolchain.cmake" `
              -DCMAKE_C_COMPILER="$gcc" `
              -DCMAKE_CXX_COMPILER="$gxx" `
              -DAPP_NAME="$env:APP_NAME"
          }

      - name: Build
        shell: pwsh
        run: |
          if ($env:BUILD_MODE -eq 'qt') {
            cmake --build build-qt6-release --config Release
          } else {
            cmake --build build-conan-release --config Release
          }

      - name: Package (windeployqt)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $distDir = Join-Path $PWD 'dist/windows'
          if (Test-Path $distDir) { Remove-Item -Recurse -Force $distDir }
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null

          $exePath = Join-Path $PWD $env:EXE_RELATIVE_PATH
          if (-not (Test-Path $exePath)) { throw "exe not found at $exePath" }
          $distExePath = Join-Path $distDir $env:EXE_NAME
          Copy-Item $exePath $distExePath

          $windeployqt = Join-Path $env:QT_ROOT_DIR 'bin/windeployqt.exe'
          Write-Host "Using windeployqt: $windeployqt"
          & $windeployqt --no-translations --compiler-runtime $distExePath

          $zipPath = Join-Path $PWD $env:ZIP_NAME
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Compress-Archive -Path "$distDir/*" -DestinationPath $zipPath

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt6-mingw-windows-${{ env.BUILD_MODE }}
          path: |
            ${{ env.ZIP_NAME }}
            dist/windows/

      - name: Create GitHub Release
        if: env.RELEASE_TAG != '' && env.BUILD_MODE == 'conan'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ env.RELEASE_TAG }}"
          name: "${{ env.RELEASE_TAG }}"
          draft: ${{ env.DRAFT_FLAG == 'true' }}
          prerelease: ${{ env.PRERELEASE_FLAG == 'true' }}
          files: |
            ${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
